# Token Renewal Container - Claude Code installed but not logged in
FROM node:20

# Create claude user
RUN useradd -m -s /bin/bash claude

# Install Claude CLI globally and utilities
RUN npm install -g @anthropic-ai/claude-code && \
    apt-get update && apt-get install -y sudo curl jq && \
    echo "claude ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Create necessary directories
RUN mkdir -p /home/claude/.claude/todos \
             /home/claude/.claude/projects \
             /home/claude/.claude/statsig \
             /home/claude/workspace \
             /app/scripts

# Copy token renewal helper script
COPY scripts/token-renewal.sh /app/scripts/token-renewal.sh
RUN chmod +x /app/scripts/token-renewal.sh

# Set ownership
RUN chown -R claude:claude /home/claude /app

# Create a helpful welcome script
RUN echo '# ğŸ” Claude CLI Token Renewal Guide' > /home/claude/README-TOKEN-RENEWAL.md && \
    echo '' >> /home/claude/README-TOKEN-RENEWAL.md && \
    echo 'This container is prepared for Claude CLI token renewal.' >> /home/claude/README-TOKEN-RENEWAL.md && \
    echo '' >> /home/claude/README-TOKEN-RENEWAL.md && \
    echo '## Steps to renew your token:' >> /home/claude/README-TOKEN-RENEWAL.md && \
    echo '' >> /home/claude/README-TOKEN-RENEWAL.md && \
    echo '1. **Run Claude Login**: `claude login`' >> /home/claude/README-TOKEN-RENEWAL.md && \
    echo '2. **Follow the authentication flow in browser**' >> /home/claude/README-TOKEN-RENEWAL.md && \
    echo '3. **Extract token**: `/app/scripts/token-renewal.sh`' >> /home/claude/README-TOKEN-RENEWAL.md && \
    echo '4. **Update .env-secret on host with the output**' >> /home/claude/README-TOKEN-RENEWAL.md && \
    echo '5. **Restart Container Orchestration system**' >> /home/claude/README-TOKEN-RENEWAL.md

# Set working directory
WORKDIR /home/claude

# Switch to claude user
USER claude

# Display welcome message on container start
CMD ["bash", "-c", "echo 'ğŸ” Claude CLI Token Renewal Container Ready!' && echo 'ğŸ“– See README-TOKEN-RENEWAL.md for instructions' && echo 'ğŸš€ Run: claude login' && echo && exec bash"]