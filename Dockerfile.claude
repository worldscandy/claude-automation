# Claude CLI実行用のDockerイメージ
FROM node:20

# Create non-root user
RUN useradd -m -s /bin/bash claude

# Install Claude CLI and sudo globally as root
RUN npm install -g @anthropic-ai/claude-code && \
    apt-get update && apt-get install -y sudo && \
    echo "claude ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Set up workspace and required directories as root
RUN mkdir -p /home/claude/workspace \
             /app/workspaces \
             /app/sessions \
             /app/auth \
             /tmp/claude-tasks

# Set proper permissions for mounted volumes
RUN chown -R claude:claude /home/claude /app /tmp/claude-tasks

# Copy and set up entrypoint script
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Switch to non-root user
USER claude
WORKDIR /home/claude

WORKDIR /home/claude/workspace

# Default shell
SHELL ["/bin/bash", "-c"]

# Entry point with permission fix
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["bash"]